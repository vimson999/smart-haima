@using Webdiyer.WebControls.Mvc
@using X3
@model  PagedList<View_SuperviserTripLog>
    @{
        ViewBag.Title = "日志";
        ViewBag.triplogdetail = "active";
        bool firstData = true;
        string csp = "in";
        HaiMaApp db = new HaiMaApp();
    }
    <link href="~/Content/themes/base/all.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-ui-1.11.4.min.js"></script>   
    <div class="row">
        @using (Html.BeginForm("triplogdetail", "home", FormMethod.Get, new { @class = "form-horizontal", role = "form" }))
        {
            <div class="form-inline" style="margin:10px 0px 10px 0px;">
                <div class="input-group">
                    <span class="input-group-addon" id="sizing-addon3">店名:　　</span>
                    <input type="text" name="dm" class="form-control" placeholder="@ViewBag.dm" aria-describedby="sizing-addon3" />
                </div>
                <div class="input-group">
                    <span class="input-group-addon" id="sizing-addon5">开始时间:</span>
                    <input type="text" name="starttime" id="starttime" class="form-control " aria-describedby="sizing-addon5" value="@ViewBag.starttime" />
                </div>
                <div class="input-group">
                    <span class="input-group-addon" id="sizing-addon6">结束时间:</span>
                    <input type="text" name="endtime" id="endtime" class="form-control" aria-describedby="sizing-addon6" value="@ViewBag.endtime" />
                </div>
                <input type="hidden" name="dudaomz" id="dudaomz" value="@ViewBag.dudaomz" />
                <input type="submit" class="form-control" style="margin:0px 5px; " value="搜索" />
                @Html.ActionLink("导出excel", "dudaologToExcel", new { area = @ViewBag.area, dm = ( @ViewBag.dm=="请输入关键字"?"":@ViewBag.dm), dudaomz = @ViewBag.dudaomz, starttime = @ViewBag.starttime, endtime = @ViewBag.endtime }, new { @class = "btn btn-default", @role = "button" })
                &nbsp;@Html.ActionLink("转到督导维度统计页", "SuperviserStatistics", new { area = @ViewBag.area, starttime = @ViewBag.starttime, endtime = @ViewBag.endtime }, new { @class = "btn btn-default", @role = "button" })
            </div>
            <div class="form-inline">

            </div>
        }
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
            @foreach (var item in Model)
            {
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="heading@{@item.id}">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapse@{@item.id}" aria-expanded="@firstData.ToString().ToLower()" aria-controls="collapse@{@item.id}">
                                <strong>
                                    @item.dianming
                                </strong>（@item.StaffName @item.riqi）
                                @{firstData = false;}
                            </a>
                            <span style="float:right;">
                                <a data-toggle="modal" data-target="#pifu" data-whatever="@item.id" style="cursor:pointer;">批复</a>
                                @*&nbsp;<a style="cursor:pointer;" onclick="delog(@item.id)">删除</a>*@
                            </span>
                        </h4>
                    </div>
                    <div id="collapse@{@item.id}" class="panel-collapse collapse @csp" role="tabpanel" aria-labelledby="heading@{@item.id}">
                        <div class="panel-body">
                            <div class="form-inline " style="margin:5px">
                                <label for="content" style="width:100px">地址：</label>
                                <span>@item.position</span>
                            </div>
                            <div class="form-inline " style="margin:5px">
                                <label for="content" style="width:100px">店描述：</label>
                                <span>@item.miaoshu</span>
                            </div>
                            <div class="form-inline " style="margin:5px">
                                <label for="content" style="width:100px">整改要求：</label>
                                <span>@item.zhenggai</span>
                            </div>
                            <div class="form-inline " style="margin:5px">
                                <label for="content" style="width:100px">协调申请：</label>
                                <span>@item.xietiao</span>
                            </div>
                            <div class="row">
                                @{
                                  var listtp = db.ChuChaiImages.Where(p => p.chuchai_id == item.id).OrderByDescending(p => p.id);
                                  if (listtp == null || listtp.Count() == 0)
                                  {
                                      return;
                                  }
                                foreach (var p in listtp)
                                {
                                    <div class="col-md-1">
                                        <a tabindex="0" role="button" data-toggle="modal" data-target="#myModal@{@p.id}"><img title="点击看大图" src="../../ChuChaiRiZhi/@p.pic_name" style="width:80px;height:60px;" /></a>
                                        @*<div class="modal fade" id="myModal@{@p.id}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header" style="border:0px;">
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <img style="max-width:570px;" src="../../ChuChaiRiZhi/@p.pic_name">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>*@

                                        <div class="modal fade" id="myModal@{@p.id}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header" style="border:0px;">
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div id="myCarousel@{@p.id}" class="carousel slide">
                                                            <!-- Carousel items -->
                                                            <div class="carousel-inner">
                                                                @{
                                        foreach (var x in listtp)
                                        {
                                            if (@p.id == x.id)
                                            {
                                                    <div class="item active"><img style="max-width:570px;" src="../../ChuChaiRiZhi/@x.pic_name"></div>
                                            }
                                            else
                                            {
                                                    <div class="item"><img style="max-width:570px;" src="../../ChuChaiRiZhi/@x.pic_name"></div>
                                            }
                                        }
                                                                }
                                                            </div>
                                                            <!-- Carousel nav -->
                                                            <a class="carousel-control left" href="#myCarousel@{@p.id}" data-slide="prev">&lsaquo;</a>
                                                            <a class="carousel-control right" href="#myCarousel@{@p.id}" data-slide="next">&rsaquo;</a>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                }
                                }
                                </div>
                             <div>
                            <h4>管理员批复：</h4>
                            <ul id="pifu@{@item.id}">
                                @{
                                var listpifu = db.PiFuOnChuChai.Where(p => p.chuchaiID == item.id).OrderByDescending(p => p.id);
                                foreach (var p in listpifu)
                                {
                                    <li class="list-group-item list-group-item-danger">@p.PiFuContent</li>
                                }
                                                }
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                csp = "";
            }
        </div>
        <div>
            <div style="float:left;padding:10px 0">共 @Model.TotalPageCount 页 @Model.TotalItemCount 条</div>
            @Html.Pager(Model, new PagerOptions { PageIndexParameterName = "pn", ShowPageIndexBox = true, CurrentPagerItemWrapperFormatString = "<span class=\"current\">{0}</span>" }, new { id = "badoopager" })<span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span>
        </div>

        <div class="modal fade" id="pifu" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">批复</h4>
                    </div>
                    <div class="modal-body">
                        <input id="pifuid" type="hidden" />
                        <div class="form-group">
                            <label for="message-text" class="control-label">内容:</label>
                            <textarea class="form-control" id="message-text"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="tjpifu()" id="save">确定</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal" id="btn_dialogclose">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @section Scripts{@{Html.RegisterMvcPagerScriptResource();}}
    <script>
        $(function () {
            $('[data-toggle="popover"]').popover();
            $("#starttime,#endtime").datepicker();
        })
        $('#pifu').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget) // Button that triggered the modal
            var recipient = button.data('whatever') // Extract info from data-* attributes
            var modal = $(this)
            $("#pifuid").val(recipient);
            $("#message-text").val('');     //clear value
        })
        function tjpifu() {
            $("#save").attr("disabled","disabled");
            var postdata = { id: $("#pifuid").val(), content: $("#message-text").val() };
            $.ajax({
                type: "post",
                url: "tipifu",
                data: postdata,
                dataType: "text",
                success: function (data) {
                    $("#btn_dialogclose").click();
                    $('#pifu' + $("#pifuid").val() + '').prepend('<li class="list-group-item list-group-item-danger">' + $("#message-text").val() + '</li>');
                    $("#save").removeAttr("disabled");
                }
            });
        }
        //function delog(cid) {
        //    if (confirm("确定删除？")) {
        //        var postdata = { id: cid };
        //        $.ajax({
        //            type: "post",
        //            url: "DeleteLog",
        //            data: postdata,
        //            dataType: "json",
        //            success: function (data) {
        //                location.reload();
        //            }
        //        });
        //    }
        //}
    </script>
