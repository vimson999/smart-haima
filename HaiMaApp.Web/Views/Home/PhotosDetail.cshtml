@using Webdiyer.WebControls.Mvc
@using X3
@model  PagedList<View_SuperviserUploadPhotos>
@{
    ViewBag.Title = "督导拍照上传";
    ViewBag.photosdetail = "active";
    bool firstData = true;
    string csp = "in";
    HaiMaApp db = new HaiMaApp();
}
    <link href="~/Content/themes/base/all.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-ui-1.11.4.min.js"></script>
    <div class="row">
        @using (Html.BeginForm("photosdetail", "home", FormMethod.Get, new { @class = "form-horizontal", role = "form" }))
        {
        <div class="form-inline" style="margin:10px 0px 10px 0px;">
            <div class="input-group">
                <span class="input-group-addon" id="sizing-addon3">店名:　　</span>
                <input type="text" name="dm" class="form-control" placeholder="@ViewBag.dm" aria-describedby="sizing-addon3" />
            </div>
            <div class="input-group">
                <span class="input-group-addon" id="sizing-addon4">主项目:　</span>
                <select id="mainproject" name="mainproject" class="form-control" style="width:180px;" mainproject="@ViewBag.mainproject">
                    <option value="0">--请选择--</option>
                    <option value="展厅布置">展厅布置</option>
                    <option value="营销活动">营销活动</option>
                    <option value="培训会议">培训会议</option>
                    <option value="广宣资料">广宣资料</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div class="input-group">
                <span class="input-group-addon">子项目:　</span>
                <select id="childproject" name="childproject" class="form-control" childproject="@ViewBag.childproject" value="@ViewBag.childproject"><option value="0">--请选择--</option></select>
            </div>
            <div style="height:5px; line-height:5px;"></div>
            <div class="input-group">
                <span class="input-group-addon" id="sizing-addon5">开始时间:</span>
                <input type="text" name="starttime" id="starttime" class="form-control " aria-describedby="sizing-addon5" value="@ViewBag.starttime" />
            </div>
            <div class="input-group">
                <span class="input-group-addon" id="sizing-addon6">结束时间:</span>
                <input type="text" name="endtime" id="endtime" class="form-control" aria-describedby="sizing-addon6" value="@ViewBag.endtime" />
            </div>
            <input type="hidden" name="dudaomz" id="dudaomz" value="@ViewBag.dudaomz" />
            <input type="submit" class="form-control" style="margin:0px 2px; " value="搜索" />
            @Html.ActionLink("导出excel", "dudaologToExcel", new { area=@ViewBag.area,dm =( @ViewBag.dm=="请输入关键字"?"":@ViewBag.dm), dudaomz = @ViewBag.dudaomz, starttime = @ViewBag.starttime, endtime = @ViewBag.endtime }, new { @class = "btn btn-default", @role = "button" })
            &nbsp;@Html.ActionLink("转到督导维度统计页", "SuperviserPhotosStatistics", new { area = @ViewBag.area, starttime = @ViewBag.starttime, endtime = @ViewBag.endtime }, new { @class = "btn btn-default", @role = "button" })
        </div>
        <div class="form-inline">
        </div>
        }
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
            @foreach (var item in Model)
            {
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="heading@{@item.id}">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse@{@item.id}" aria-expanded="@firstData.ToString().ToLower()" aria-controls="collapse@{@item.id}">
                            <strong>
                                @item.dianming 
                            </strong>（@item.StaffName @item.riqi.ToDateString()）
                            @{firstData = false;}
                        </a>
                        <span style="float:right;">
                            <a data-toggle="modal" data-target="#pifu" data-whatever="@item.id" style="cursor:pointer;">批复</a>
                            @*&nbsp;<a style="cursor:pointer;" onclick="delog(@item.id)">删除</a>*@
                        </span>
                    </h4>
                </div>
                <div id="collapse@{@item.id}" class="panel-collapse collapse @csp" role="tabpanel" aria-labelledby="heading@{@item.id}">
                    <div class="panel-body">
                        <div class="form-inline " style="margin:5px">
                            <label for="content" style="width:100px">主项目：</label>
                            <span>@item.mainproject</span>
                        </div>
                        <div class="form-inline " style="margin:5px">
                            <label for="content" style="width:100px">子项目：</label>
                            <span>@item.childproject</span>
                        </div>
                        <div class="form-inline " style="margin:5px">
                            <label for="content" style="width:100px">地址：</label>
                            <span>@item.position</span>
                        </div>
                        <div class="form-inline " style="margin:5px">
                            <label for="content" style="width:100px">描述：</label>
                            <span>@item.description</span>
                        </div>
                        <div class="row">
                            <div class="col-md-1">
                                <a tabindex="0" role="button" data-toggle="modal" data-target="#myModal@{@item.id}"><img title="点击看大图" src="../../UploadImages/@item.picname" style="width:80px;height:60px;" /></a>
                                <div class="modal fade" id="myModal@{@item.id}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header" style="border:0px;">
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                            </div>
                                            <div class="modal-body">
                                                <img style="max-width:570px;" src="../../UploadImages/@item.picname">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4>管理员批复：</h4>
                            <ul id="pifu@{@item.id}">
                                @{
                                var listpifu = db.PiFuOnPictureUpload.Where(p => p.PictureUploadID == item.id).OrderByDescending(p => p.Id);
                                foreach (var p in listpifu)
                                {
                                <li class="list-group-item list-group-item-danger">@p.PiFuContent</li>
                                }
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            csp = "";
            }
        </div>
        <div>
            <div style="float:left;padding:10px 0">共 @Model.TotalPageCount 页 @Model.TotalItemCount 条</div>
            @Html.Pager(Model, new PagerOptions { PageIndexParameterName = "pn", ShowPageIndexBox = true, CurrentPagerItemWrapperFormatString = "<span class=\"current\">{0}</span>" }, new { id = "badoopager" })<span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span><span class=\"current\"></span>
        </div>
        <div class="modal fade" id="pifu" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">批复</h4>
                    </div>
                    <div class="modal-body">
                        <input id="pifuid" type="hidden" />
                        <div class="form-group">
                            <label for="message-text" class="control-label">内容:</label>
                            <textarea class="form-control" id="message-text"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="tjpifu()" id="save">确定</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal" id="btn_dialogclose">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @section Scripts{@{Html.RegisterMvcPagerScriptResource();}}
    <script>
        $(function () {
            $('[data-toggle="popover"]').popover();
            $("#starttime,#endtime").datepicker();

            //
            initproject();

            $('#pifu').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget) // Button that triggered the modal
                var recipient = button.data('whatever') // Extract info from data-* attributes
                var modal = $(this)
                $("#pifuid").val(recipient);
                $("#message-text").val('');     //clear value
            })            
        })

        function initproject() {
            var mainproject = $("#mainproject").attr("mainproject");
            var childproject = $("#childproject").attr("childproject");
            $("#mainproject option").each(function () {
                var obj = $(this);
                if (obj.val() == mainproject) {
                    obj.attr("selected", "selected");
                    $("#mainproject").change();
                }
            });
            
            $("#childproject option").each(function () {
                var obj = $(this);
                if (obj.val() == childproject)
                    obj.attr("selected", "selected");
            });
        }
        
        $("#mainproject").change(function () {
            var mainid = $(this).val();
            if (mainid < 1)
                return false;
            var childids = [];

            switch (mainid) {
                case "展厅布置":
                    childids = ["物料", "展车", "广告机", "其他"];
                    break;
                case "营销活动":
                    childids = ["车展", "中篷车", "县镇行动", "上市活动", "日常推广", "其他"];
                    break;
                case "培训会议":
                    childids = ["区域会议", "单店会议", "培训", "其他"];
                    break;
                case "广宣资料":
                    childids = ["发票照片", "投放照片", "其他"];
                    break;
                case "其他":
                    childids = ["其他"];
                    break;
            }
            $("#childproject option:gt(0)").remove();
            for (var i in childids) {
                $("#childproject").append($("<option/>").text(childids[i]).attr("value", childids[i]));
            }
        })

        function tjpifu() {
            $("#save").attr("disabled", "disabled");
            var postdata = { id: $("#pifuid").val(), content: $("#message-text").val() };
            $.ajax({
                type: "post",
                url: "tipifupictureupload",
                data: postdata,
                dataType: "text",
                success: function (data) {
                    $("#btn_dialogclose").click();
                    $('#pifu' + $("#pifuid").val() + '').prepend('<li class="list-group-item list-group-item-danger">' + $("#message-text").val() + '</li>');
                    $("#save").removeAttr("disabled");
                }
            });
        }
        
        //function delog(cid) {
        //    if (confirm("确定删除？")) {
        //        var postdata = { id: cid };
        //        $.ajax({
        //            type: "post",
        //            url: "DeleteLog",
        //            data: postdata,
        //            dataType: "json",
        //            success: function (data) {
        //                location.reload();
        //            }
        //        });
        //    }
        //}
    </script>
